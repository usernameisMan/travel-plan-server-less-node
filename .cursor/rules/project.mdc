---
description: Travel Plan Server - æ—…è¡Œè§„åˆ’å¹³å°åç«¯å¼€å‘è§„èŒƒ
globs: ["**/*.ts", "**/*.js", "**/*.json", "**/*.md"]
alwaysApply: true
---

# Travel Plan Server å¼€å‘è§„èŒƒ

## é¡¹ç›®æ¦‚è¿°
è¿™æ˜¯ä¸€ä¸ªåŸºäº Node.js çš„æ— æœåŠ¡å™¨æ—…è¡Œè§„åˆ’å¹³å°ï¼Œæ”¯æŒç”¨æˆ·åˆ›å»ºã€åˆ†äº«å’Œè´­ä¹°æ—…è¡ŒåŒ…ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- æ—…è¡ŒåŒ…åˆ›å»ºå’Œç®¡ç† (Packets)
- è¡Œç¨‹è§„åˆ’ (Itinerary Days) 
- åœ°ç‚¹æ ‡è®° (Markers)
- ç”¨æˆ·è®¤è¯å’Œæˆæƒ
- å†…å®¹åˆ†äº«å’Œå•†ä¸šåŒ–
- æ”¯ä»˜å’Œè®¢å•ç®¡ç†

## æŠ€æœ¯æ ˆè§„èŒƒ

### åç«¯æ¶æ„
- **è¿è¡Œæ—¶**: Node.js + TypeScript
- **æ¡†æ¶**: Express.js
- **ORM**: TypeORM
- **è®¤è¯**: Auth0 JWT
- **æ•°æ®åº“**: Neon PostgreSQL
- **éƒ¨ç½²**: Vercel Serverless

### å‰ç«¯é›†æˆ
- **å‰ç«¯æ¡†æ¶**: Next.js (localhost:3000)
- **é€šä¿¡**: RESTful API + JSON

## æ•°æ®åº“è®¾è®¡è§„èŒƒ

### å‘½åçº¦å®š
- **è¡¨å**: ä½¿ç”¨å•æ•°å½¢å¼ (`packet`, `marker`, `user`)
- **å­—æ®µå**: ä½¿ç”¨ snake_case (`user_id`, `created_at`)
- **ä¸»é”®**: ä¼˜å…ˆä½¿ç”¨ `id` (integer) æˆ– UUID (text)
- **å¤–é”®**: ä½¿ç”¨ `è¡¨å_id` æ ¼å¼

### æ•°æ®åº“ç¯å¢ƒ
- **å¼€å‘ç¯å¢ƒ**: development åˆ†æ”¯ -> travel-plan æ•°æ®åº“
- **ç”Ÿäº§ç¯å¢ƒ**: production åˆ†æ”¯ -> neondb æ•°æ®åº“
- **é¡¹ç›®ID**: snowy-firefly-19991504

### æ ¸å¿ƒè¡¨ç»“æ„
```sql
-- æ—…è¡ŒåŒ…ä¸»è¡¨
packet: id(int), name(text), user_id(text), description(text), 
        cost(numeric), currency_code(text), is_public(boolean)

-- è¡Œç¨‹æ—¥è¡¨  
itinerary_day: id(text/uuid), name(text), packet_id(text), 
               day_number(text), description(text), sort_order(int)

-- åœ°ç‚¹æ ‡è®°è¡¨
marker: id(uuid), title(text), type(text), lng(text), lat(text), 
        day_id(text), sort_order(int)
```

## API è®¾è®¡è§„èŒƒ

### è·¯ç”±ç»“æ„
```
GET    /api/packets              # è·å–ç”¨æˆ·æ—…è¡ŒåŒ…åˆ—è¡¨
GET    /api/packets/:id          # è·å–å•ä¸ªæ—…è¡ŒåŒ…
POST   /api/packets              # åˆ›å»ºæ—…è¡ŒåŒ…
PUT    /api/packets/:id          # æ›´æ–°æ—…è¡ŒåŒ…
DELETE /api/packets/:id          # åˆ é™¤æ—…è¡ŒåŒ… (çº§è”åˆ é™¤)
GET    /api/packets/:id/with-itinerary  # è·å–å®Œæ•´è¡Œç¨‹æ•°æ®
POST   /api/packets/with-itinerary      # åˆ›å»ºåŒ…å«è¡Œç¨‹çš„æ—…è¡ŒåŒ…
```

### å“åº”æ ¼å¼
```typescript
// æˆåŠŸå“åº”
{
  success: true,
  data: T,
  message: string,
  count?: number  // åˆ—è¡¨æ¥å£
}

// é”™è¯¯å“åº”  
{
  success: false,
  message: string,
  error?: any     // å¼€å‘ç¯å¢ƒ
}
```

### è®¤è¯æœºåˆ¶
- ä½¿ç”¨ Auth0 JWT Bearer Token
- ä» `req.user.sub` è·å–ç”¨æˆ·ID
- æ‰€æœ‰ä¸šåŠ¡æ¥å£éƒ½éœ€è¦è®¤è¯
- ç”¨æˆ·ID æ ¼å¼: `google-oauth2|107624379288487963463`

## ä»£ç è§„èŒƒ

### TypeScript é…ç½®
- ä¸¥æ ¼æ¨¡å¼å¼€å¯
- ä½¿ç”¨æ¥å£ (interface) è€Œéç±»å‹åˆ«å
- é¿å…ä½¿ç”¨ `any`ï¼Œä¼˜å…ˆä½¿ç”¨å…·ä½“ç±»å‹

### æ–‡ä»¶ç»“æ„
```
api/                    # API è·¯ç”±
â”œâ”€â”€ middleware/         # ä¸­é—´ä»¶
â”œâ”€â”€ packets.ts         # æ—…è¡ŒåŒ…ç›¸å…³æ¥å£
â””â”€â”€ index.ts           # å…¥å£æ–‡ä»¶

lib/                   # æ ¸å¿ƒåº“æ–‡ä»¶
â”œâ”€â”€ entities/          # TypeORM å®ä½“
â”œâ”€â”€ dto/              # æ•°æ®ä¼ è¾“å¯¹è±¡
â””â”€â”€ data-source.ts    # æ•°æ®åº“è¿æ¥

docs/                 # é¡¹ç›®æ–‡æ¡£
```

### å®ä½“è®¾è®¡æ¨¡å¼
```typescript
@Entity("table_name")
export class EntityName {
  @PrimaryColumn()
  id: string;
  
  @Column({ name: "field_name", nullable: true })
  fieldName: string;
  
  @CreateDateColumn({ name: "created_at" })
  createdAt: Date;
  
  @UpdateDateColumn({ name: "updated_at" })  
  updatedAt: Date;
}
```

### DTO è®¾è®¡æ¨¡å¼
```typescript
export class CreateEntityDto {
  @IsNotEmpty()
  @IsString()
  name: string;
  
  @IsOptional()
  @IsString()
  description?: string;
}

export class EntityResponseDto {
  success: boolean;
  data: EntityData;
  message: string;
  
  constructor(entity: Entity, message: string) {
    this.success = true;
    this.data = new EntityData(entity);
    this.message = message;
  }
}
```

## ä¸šåŠ¡é€»è¾‘è§„èŒƒ

### æ•°æ®åº“äº‹åŠ¡
- æ¶‰åŠå¤šè¡¨æ“ä½œå¿…é¡»ä½¿ç”¨äº‹åŠ¡
- ä½¿ç”¨ QueryRunner è¿›è¡Œäº‹åŠ¡ç®¡ç†
- é”™è¯¯æ—¶è‡ªåŠ¨å›æ»š

```typescript
const queryRunner = AppDataSource.createQueryRunner();
await queryRunner.connect();
await queryRunner.startTransaction();

try {
  // ä¸šåŠ¡æ“ä½œ
  await queryRunner.commitTransaction();
} catch (error) {
  await queryRunner.rollbackTransaction();
  throw error;
} finally {
  await queryRunner.release();
}
```

### çº§è”åˆ é™¤ç­–ç•¥
- åˆ é™¤ packet â†’ åˆ é™¤ç›¸å…³ itinerary_day â†’ åˆ é™¤ç›¸å…³ marker
- åˆ é™¤é¡ºåº: markers â†’ itinerary_days â†’ packet
- ç¡®ä¿ä¸ç•™å­¤ç«‹æ•°æ®

### å­—æ®µæ˜ å°„è§„èŒƒ
- å‰ç«¯ `dayText` â†’ æ•°æ®åº“ `name` (itinerary_day)
- å‰ç«¯ `day` â†’ æ•°æ®åº“ `day_number`
- å…¼å®¹ GET å’Œ POST çš„ä¸åŒå­—æ®µå

```typescript
// å…¼å®¹æ€§å¤„ç†
name: day.dayText || (day as any).name
```

## é”™è¯¯å¤„ç†è§„èŒƒ

### é”™è¯¯ç±»å‹
- 401: è®¤è¯å¤±è´¥
- 403: æƒé™ä¸è¶³  
- 404: èµ„æºä¸å­˜åœ¨
- 400: è¯·æ±‚å‚æ•°é”™è¯¯
- 500: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

### è°ƒè¯•æ—¥å¿—
```typescript
console.log("ğŸ” Processing:", data);
console.log("âœ… Success:", result);  
console.error("âŒ Error:", error);
```

### å¼€å‘ç¯å¢ƒæ—¥å¿—
- ç”Ÿäº§ç¯å¢ƒä¸æš´éœ²å…·ä½“é”™è¯¯ä¿¡æ¯
- å¼€å‘ç¯å¢ƒè¿”å›å®Œæ•´é”™è¯¯å †æ ˆ

## å®‰å…¨è§„èŒƒ

### æ•°æ®è®¿é—®æ§åˆ¶
- æ‰€æœ‰ä¸šåŠ¡æ•°æ®å¿…é¡»æ ¡éªŒ `userId`
- ä¸å…è®¸è·¨ç”¨æˆ·æ•°æ®è®¿é—®
- SQL æŸ¥è¯¢å¿…é¡»åŒ…å«ç”¨æˆ·è¿‡æ»¤æ¡ä»¶

```typescript
const userPackets = await packetRepository.find({
  where: { userId },  // å¿…é¡»åŒ…å«ç”¨æˆ·è¿‡æ»¤
  order: { createdAt: "DESC" }
});
```

### è¾“å…¥éªŒè¯
- ä½¿ç”¨ class-validator è¿›è¡Œå‚æ•°éªŒè¯
- å¿…è¦çš„å­—æ®µä½¿ç”¨ `@IsNotEmpty()`
- å¯é€‰å­—æ®µä½¿ç”¨ `@IsOptional()`

## åˆ†äº«åŠŸèƒ½è®¾è®¡

### æ¦‚è¿°
å®Œæ•´çš„æ—…è¡ŒåŒ…åˆ†äº«åŠŸèƒ½ï¼Œæ”¯æŒå…è´¹åˆ†äº«å’Œä»˜è´¹åˆ†äº«ä¸¤ç§æ¨¡å¼ã€‚è¯¦ç»†è®¾è®¡æ–¹æ¡ˆè¯·å‚è€ƒï¼š`docs/sharing-feature-design.md`

### æ ¸å¿ƒåŠŸèƒ½
- **å…è´¹åˆ†äº«**: ç”¨æˆ·å¯ä»¥å…è´¹åˆ†äº«æ—…è¡ŒåŒ…ï¼Œä»»ä½•äººéƒ½å¯ä»¥æŸ¥çœ‹å®Œæ•´å†…å®¹
- **ä»˜è´¹åˆ†äº«**: ç”¨æˆ·è®¾ç½®ä»·æ ¼ï¼Œè®¿é—®è€…éœ€è¦è´­ä¹°æ‰èƒ½æŸ¥çœ‹å®Œæ•´å†…å®¹
- **é¢„è§ˆæ¨¡å¼**: ä»˜è´¹å†…å®¹æä¾›é¢„è§ˆï¼Œæ˜¾ç¤ºéƒ¨åˆ†è¡Œç¨‹å¸å¼•è´­ä¹°
- **åˆ†äº«ç»Ÿè®¡**: æµè§ˆé‡ã€è´­ä¹°é‡ã€æ”¶å…¥ç­‰æ•°æ®ç»Ÿè®¡
- **ç¤¾äº¤ä¼ æ’­**: æ”¯æŒç”ŸæˆäºŒç»´ç å’Œå„ç§ç¤¾äº¤å¹³å°åˆ†äº«

### æ•°æ®åº“æ‰©å±•
```sql
-- æ‰©å±• packet è¡¨
ALTER TABLE packet ADD COLUMN share_code TEXT UNIQUE;
ALTER TABLE packet ADD COLUMN share_type TEXT DEFAULT 'private'; -- 'private'/'free'/'paid'
ALTER TABLE packet ADD COLUMN share_price NUMERIC(10,2);
ALTER TABLE packet ADD COLUMN share_enabled_at TIMESTAMP;
ALTER TABLE packet ADD COLUMN share_views INTEGER DEFAULT 0;
ALTER TABLE packet ADD COLUMN share_purchases INTEGER DEFAULT 0;

-- æ–°å¢è®¿é—®è®°å½•è¡¨
CREATE TABLE packet_share_access (
  id SERIAL PRIMARY KEY,
  packet_id INTEGER REFERENCES packet(id),
  share_code TEXT NOT NULL,
  visitor_ip INET,
  visitor_user_id TEXT,
  access_type TEXT, -- 'view'/'purchase'
  user_agent TEXT,
  accessed_at TIMESTAMP DEFAULT NOW()
);
```

### åˆ†äº«æ¥å£è®¾è®¡
```
# åˆ†äº«ç®¡ç†
POST   /api/packets/:id/share        # å¼€å¯åˆ†äº«
PUT    /api/packets/:id/share        # æ›´æ–°åˆ†äº«è®¾ç½®
DELETE /api/packets/:id/share        # å…³é—­åˆ†äº«
GET    /api/packets/:id/share/stats  # è·å–åˆ†äº«ç»Ÿè®¡

# åˆ†äº«è®¿é—®
GET    /api/shared/:share_code       # è®¿é—®åˆ†äº«å†…å®¹
POST   /api/shared/:share_code/purchase # è´­ä¹°ä»˜è´¹å†…å®¹
```

### å®æ–½ä¼˜å…ˆçº§
1. **P0**: åŸºç¡€åˆ†äº«åŠŸèƒ½ (å…è´¹åˆ†äº«ã€åˆ†äº«ç ç”Ÿæˆã€è®¿é—®éªŒè¯)
2. **P1**: ä»˜è´¹åˆ†äº«åŠŸèƒ½ (é¢„è§ˆæ¨¡å¼ã€æ”¯ä»˜é›†æˆã€è´­ä¹°æµç¨‹)
3. **P2**: ç”¨æˆ·ä½“éªŒä¼˜åŒ– (ç»Ÿè®¡é¢æ¿ã€äºŒç»´ç ã€ç¤¾äº¤åˆ†äº«)
4. **P3**: é«˜çº§åŠŸèƒ½ (æ¨èç³»ç»Ÿã€è¯„ä»·åé¦ˆã€æ•°æ®åˆ†æ)

## éƒ¨ç½²å’Œç¯å¢ƒ

### Vercel é…ç½®
- å‡½æ•°è¶…æ—¶: 10ç§’
- å†…å­˜é™åˆ¶: 1024MB
- ç¯å¢ƒå˜é‡é€šè¿‡ Vercel Dashboard é…ç½®

### ç¯å¢ƒå˜é‡
```
DATABASE_URL=        # Neon æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
AUTH0_AUDIENCE=      # Auth0 API æ ‡è¯†ç¬¦
AUTH0_ISSUER_BASE_URL= # Auth0 åŸŸå
NODE_ENV=production  # ç¯å¢ƒæ ‡è¯†
```

## å¼€å‘å·¥ä½œæµ

### æ•°æ®åº“å¼€å‘é¡»çŸ¥
- ä½ å¯ä»¥ä¿®æ”¹æ•°æ®åº“çš„è¡¨ä½†æ˜¯åªèƒ½åšå¢é‡ ä¸è¦åˆ é™¤å­—æ®µæˆ–è€…è¡¨

### åˆ†æ”¯ç­–ç•¥
- development: å¼€å‘åˆ†æ”¯ï¼ŒåŒ…å«æœ€æ–°åŠŸèƒ½,ç›®å‰åªä½¿ç”¨development
- production: ç”Ÿäº§åˆ†æ”¯ï¼Œç¨³å®šç‰ˆæœ¬

### æ•°æ®åº“è®¿é—®
- å¼€å‘è°ƒè¯•ä¼˜å…ˆä½¿ç”¨ development åˆ†æ”¯
- ç”Ÿäº§æ•°æ®ä½¿ç”¨ production åˆ†æ”¯
- ä½¿ç”¨ MCP Neon å·¥å…·è¿›è¡Œæ•°æ®åº“æ“ä½œ

### è°ƒè¯•æµç¨‹
1. æ·»åŠ è¯¦ç»†æ—¥å¿—
2. æŸ¥çœ‹ Vercel Function Logs
3. ä½¿ç”¨ MCP å·¥å…·ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
4. éªŒè¯ JWT Token æœ‰æ•ˆæ€§

---

éµå¾ªä»¥ä¸Šè§„èŒƒèƒ½ç¡®ä¿ä»£ç è´¨é‡ã€æ•°æ®å®‰å…¨å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚åœ¨å¼€å‘æ–°åŠŸèƒ½æ—¶ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§è¿™äº›è§„èŒƒæ‰§è¡Œã€‚